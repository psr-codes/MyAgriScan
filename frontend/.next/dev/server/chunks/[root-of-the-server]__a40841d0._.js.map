{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/kalki299/Coding/dev/college/iot/frontend/app/api/diagnose/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\n\nexport async function POST(request: Request) {\n  try {\n    const formData = await request.formData()\n    const file = formData.get(\"file\") as File\n\n    if (!file) {\n      return NextResponse.json({ error: \"No file provided\" }, { status: 400 })\n    }\n\n  // 1. Send image to your FastAPI Backend for classification\n  // Prefer the public NEXT env var (used by the client) but fall back to BACKEND_URL or localhost\n  const rawBackend = process.env.NEXT_PUBLIC_BACKEND_URL || process.env.BACKEND_URL || \"http://127.0.0.1:8000\"\n  const backendUrl = rawBackend.replace(/\\/$/, '')\n\n    // Create a new FormData for the backend request\n    const backendFormData = new FormData()\n    backendFormData.append(\"file\", file)\n\n  let result: any = undefined\n  let diseaseName = \"Unknown Disease\"\n  let confidence = 0\n\n    try {\n      const backendResponse = await fetch(`${backendUrl}/api/diagnose`, {\n        method: \"POST\",\n        body: backendFormData,\n      })\n\n      if (!backendResponse.ok) {\n        console.warn(\"Backend response not ok:\", backendResponse.status, backendResponse.statusText)\n        // Check if we can get error details\n        try {\n          const errorText = await backendResponse.text()\n          console.warn(\"Backend error details:\", errorText)\n        } catch (e) {\n          // ignore\n        }\n        throw new Error(\"Failed to get response from classification server\")\n      }\n\n  const result = await backendResponse.json()\n  // The FastAPI backend returns:\n  // { predicted_class, confidence, scores, filename }\n  // Use those keys directly so we forward the original object to the frontend.\n  diseaseName = result.predicted_class || result.class || result.prediction || \"Unknown\"\n  confidence = result.confidence || 0\n  // keep the full result to include scores/filename in the response\n    } catch (error) {\n      console.error(\"Backend error:\", error)\n      // Fallback for demo purposes if backend isn't running\n      // REMOVE THIS IN PRODUCTION\n      console.log(\"[v0] Using fallback mock data because backend failed\")\n      diseaseName = \"Tomato___Late_blight\"\n      confidence = 0.95\n    }\n\n    // For this route we only proxy to the backend classification service and\n    // return its response (plus a friendly `name` field for the frontend).\n    const displayName = String(diseaseName || '').replace(/___/g, ' ').replace(/_/g, ' ').trim()\n    const base = {\n      name: displayName,\n      predicted_class: diseaseName,\n      confidence,\n      scores: (typeof result !== 'undefined' && result.scores) ? result.scores : [],\n      filename: (typeof result !== 'undefined' && result.filename) ? result.filename : '',\n    }\n\n    return NextResponse.json(base)\n  } catch (error) {\n    console.error(\"Diagnosis error:\", error)\n    return NextResponse.json({ error: \"Failed to process diagnosis\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,WAAW,MAAM,QAAQ,QAAQ;QACvC,MAAM,OAAO,SAAS,GAAG,CAAC;QAE1B,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QACxE;QAEF,2DAA2D;QAC3D,gGAAgG;QAChG,MAAM,aAAa,6DAAuC,QAAQ,GAAG,CAAC,WAAW,IAAI;QACrF,MAAM,aAAa,WAAW,OAAO,CAAC,OAAO;QAE3C,gDAAgD;QAChD,MAAM,kBAAkB,IAAI;QAC5B,gBAAgB,MAAM,CAAC,QAAQ;QAEjC,IAAI,SAAc;QAClB,IAAI,cAAc;QAClB,IAAI,aAAa;QAEf,IAAI;YACF,MAAM,kBAAkB,MAAM,MAAM,GAAG,WAAW,aAAa,CAAC,EAAE;gBAChE,QAAQ;gBACR,MAAM;YACR;YAEA,IAAI,CAAC,gBAAgB,EAAE,EAAE;gBACvB,QAAQ,IAAI,CAAC,4BAA4B,gBAAgB,MAAM,EAAE,gBAAgB,UAAU;gBAC3F,oCAAoC;gBACpC,IAAI;oBACF,MAAM,YAAY,MAAM,gBAAgB,IAAI;oBAC5C,QAAQ,IAAI,CAAC,0BAA0B;gBACzC,EAAE,OAAO,GAAG;gBACV,SAAS;gBACX;gBACA,MAAM,IAAI,MAAM;YAClB;YAEJ,MAAM,SAAS,MAAM,gBAAgB,IAAI;YACzC,+BAA+B;YAC/B,oDAAoD;YACpD,6EAA6E;YAC7E,cAAc,OAAO,eAAe,IAAI,OAAO,KAAK,IAAI,OAAO,UAAU,IAAI;YAC7E,aAAa,OAAO,UAAU,IAAI;QAClC,kEAAkE;QAChE,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,kBAAkB;YAChC,sDAAsD;YACtD,4BAA4B;YAC5B,QAAQ,GAAG,CAAC;YACZ,cAAc;YACd,aAAa;QACf;QAEA,yEAAyE;QACzE,uEAAuE;QACvE,MAAM,cAAc,OAAO,eAAe,IAAI,OAAO,CAAC,QAAQ,KAAK,OAAO,CAAC,MAAM,KAAK,IAAI;QAC1F,MAAM,OAAO;YACX,MAAM;YACN,iBAAiB;YACjB;YACA,QAAQ,AAAC,OAAO,WAAW,eAAe,OAAO,MAAM,GAAI,OAAO,MAAM,GAAG,EAAE;YAC7E,UAAU,AAAC,OAAO,WAAW,eAAe,OAAO,QAAQ,GAAI,OAAO,QAAQ,GAAG;QACnF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,oBAAoB;QAClC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA8B,GAAG;YAAE,QAAQ;QAAI;IACnF;AACF"}}]
}